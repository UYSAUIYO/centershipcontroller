### 船舶摇杆控制命令生成流程详解

---

#### **一、摇杆信号采集与预处理**
1. **触摸输入获取**  
   用户通过触摸屏幕上的虚拟摇杆进行操作，系统实时捕获触摸点的像素坐标。摇杆控件的中心点作为坐标原点，当手指在控件区域内移动时，系统记录当前触摸点相对于中心点的水平和垂直偏移量。

2. **坐标系转换**  
   将原始像素坐标转换为以摇杆中心为原点的相对坐标。垂直轴（Y轴）方向根据屏幕坐标系调整，向下移动时数值增大，向上移动时数值减小，以符合直观操作。

---

#### **二、摇杆数据处理**
3. **极坐标计算**  
   根据偏移量计算摇杆的极坐标参数：
    - **距离**：通过勾股定理计算触摸点到中心的直线距离，反映摇杆的推动幅度。
    - **角度**：使用反正切函数计算偏移方向，确定摇杆的推动角度（以弧度表示）。

4. **死区与边缘缓冲处理**
    - **中心死区**：设定摇杆中心周围的一个圆形区域（如半径的10%），在此区域内视为无操作，避免微小抖动产生误信号。
    - **边缘缓冲**：在摇杆最大活动范围边缘保留缓冲区域（如半径的5%），限制摇杆到达物理边界时的数值突变，确保输出平滑。

5. **标准化输出**  
   将有效移动距离按比例映射到[-1, 1]的标准范围：
    - **水平分量（X轴）**：反映左右方向推力，左偏为负，右偏为正。
    - **垂直分量（Y轴）**：反映前后方向推力，后拉为负，前推为正。

---

#### **三、控制参数生成**
6. **通道推力计算**  
   将标准化值转换为实际控制信号：
    - **推力强度**：通过矢量模长计算总推力强度，映射为0-100的整数值（如0表示停止，100表示最大推力）。
    - **方向判定**：根据Y轴符号确定推进方向（正转或反转），若Y值为正则电机正向运转，反之则反向。

7. **安全状态机管理**
    - **方向切换保护**：当检测到方向变化时，立即关闭电机使能，保持至少100毫秒的停止状态，随后切换方向并重新启用电机，避免直接反转导致硬件损伤。
    - **紧急停止**：若持续500毫秒未收到新信号，自动切断所有电机电源，防止失控。

---

#### **四、数据封装与输出**
8. **控制对象建模**  
   定义包含以下字段的数据结构：
    - **通道值（CH1/CH2）**：表示左右推进器的推力强度（0-100）。
    - **方向（DIR1/DIR2）**：标识电机转向（0为反向，1为正向）。
    - **使能状态（EN1/EN2）**：控制电机启停（0为开启，1为关闭）。

9. **JSON序列化**  
   使用Gson库将控制对象转换为标准JSON字符串，结构示例如下：
   ```json
   {
     "SHIPMOTRO": {
       "CH1": 75,    // 左推进器推力
       "DIR1": 1,    // 左推进器方向
       "EN1": 0,     // 左推进器使能
       "CH2": 60,    // 右推进器推力
       "DIR2": 0,    // 右推进器方向
       "EN2": 0      // 右推进器使能
     }
   }
   ```   

---

#### **五、实时控制与异常处理**
11. **数据发送频率**  
    系统以（每200毫秒）更新并发送控制命令，保证船舶响应的实时性。

12. **异常监控机制**
    - **信号丢失检测**：若超时未收到操作指令，自动进入安全模式，停止所有推进器。
    - **数值滤波**：对连续信号进行移动平均滤波，消除突发噪声导致的抖动。

---

### **流程总结**
1. **输入**：用户通过屏幕摇杆操作产生原始触摸信号。
2. **处理**：坐标转换→死区过滤→标准化输出→生成控制参数。
3. **封装**：构建数据对象→序列化为JSON→添加通信协议帧。
4. **输出**：通过websocket将命令发送至船舶控制系统，驱动电机执行动作。

该流程平衡了操作的直观性、硬件安全性与系统实时性，确保用户通过单摇杆即可精准控制船舶的双向推进系统。